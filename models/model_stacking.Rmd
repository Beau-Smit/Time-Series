---
title: "Model Stacking"
author: "Beau Smit"
date: "2/28/2022"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(caret)
```

### Simply take the average of the model predictions

```{r eval=FALSE, include=FALSE}
mean_preds <- corn_preds %>% 
  mutate(mean_pred = rowMeans(corn_preds %>% select(-Year)))
```

```{r eval=FALSE, include=FALSE}
plot_df <- ag_df %>%
  dplyr::select(c("Year", "Corn_BUperAcre")) %>%
  left_join(., mean_preds, by="Year") %>%
  dplyr::select(c("Year", "Corn_BUperAcre", "mean_pred"))

ggplot(data = plot_df) + 
  geom_line(aes(x=Year, y=Corn_BUperAcre)) + 
  geom_line(aes(x=Year, y=mean_pred, color="prediction"))
```

### Build stacking model

```{r}
#### creating sampling seeds ####
set.seed(123)
seeds <- vector(mode = "list", length = 528)
for(i in 1:527) seeds[[i]] <- sample.int(1000, 25)

## For the last model:
seeds[[528]] <- sample.int(1000, 1)

myTimeControl <- trainControl(method = "timeslice",
                              initialWindow = 10,
                              horizon = 5,
                              fixedWindow = FALSE,
                              allowParallel = TRUE,
                              seeds = seeds)
tuneLength.num <- 5

# function to take an arbitrary number of models that use the predict() method and stack them
fit_stacked_mdl <- function(true_values, predictions){
  # train the stacked model with time series cross validation
  n_models <- dim(predictions)[2]
  
  stacked.mod <- train(x=predictions,
                  y=true_values,
                  method = "lm",
                  trControl = myTimeControl,
                  tuneLength=tuneLength.num,
                  metric='RMSE') # no MAPE
  
  print(stacked.mod$finalModel)
  
  return(stacked.mod)
  
}
```

```{r include=FALSE}
# example set of 3 models' predictions, just combine them and pass into fit_stacked_mdl()
#random_preds_1 <- runif(100, min=170, max=200)
#random_preds_2 <- runif(100, min=165, max=205)
#norm_preds <- rnorm(100, mean=185, sd=10)

#predictions <- cbind(random_preds_1, random_preds_2, norm_preds)
#true_values <- rep(corn_validation$Corn_BUperAcre, 25)
#fit_stacked_mdl(true_values, predictions)
```

```{r}
train_test_split <- function(commod, cutoff_year){
  file_name <- paste0("../data/", commod, "_baseline_predictions.csv")
  preds <- read.csv(file_name)
  train <- preds %>% filter(year < cutoff_year)
  test <- preds %>% filter(year >= cutoff_year)
  
  train_test <- list("train" = train, "test" = test)
  return(train_test)
}
```

```{r}
# calculate MAPE for each model
get_MAPE <- function(true_values, predictions){
  ape <- ((abs(true_values - predictions)) / abs(true_values)) * 100
  mape <- round(mean(ape), digits = 2)
  return(mape)
}
```

```{r}
baseline_models <- c("naive", "drift", "holt", "arima")
commodities <- list("corn", "wheat", "soy")

for (commod in commodities){
  train_test <- train_test_split(commod, 2017)
  train <- train_test$train
  test <- train_test$test
  
  y_train <- train$true_value
  X_train <- train %>% select(naive, drift, holt, arima)
  y_test <- test$true_value
  X_test <- test %>% select(naive, drift, holt, arima)
  
  stacked.mod <- fit_stacked_mdl(y_train, X_train)
  
  #print(stacked.mod)
  
  mdl_forecast <- predict(stacked.mod, X_test)
  mape <- get_MAPE(y_test, mdl_forecast)
  print(mape)
  plot_forecast <- c(rep(NA, 2017-1980), mdl_forecast)
  
  plot(c(train_test$train$true_value, train_test$test$true_value), type='l', main=commod)
  lines(plot_forecast, col='red')
  
}
```


```{r}
train_test <- train_test_split("corn", 2017)
corn_X_test <- train_test$test %>% select(baseline_models)
corn_y_test <- train_test$test$true_value
sapply(corn_X_test, function(x) get_MAPE(corn_y_test, x))

plot(c(train_test$train$true_value, train_test$test$true_value), type='l', main='Corn')
sapply(corn_X_test, function(x) lines(c(rep(NA, 2017-1980), x), col=x))
```

```{r}
train_test <- train_test_split("wheat", 2017)
wheat_X_test <- train_test$test %>% select(baseline_models)
wheat_y_test <- train_test$test$true_value
sapply(wheat_X_test, function(x) get_MAPE(wheat_y_test, x))

plot(c(train_test$train$true_value, train_test$test$true_value), type='l', main='Wheat')
sapply(wheat_X_test, function(x) lines(c(rep(NA, 2017-1980), x), col=x))
```


```{r}
train_test <- train_test_split("soy", 2017)
soy_X_test <- train_test$test %>% select(baseline_models)
soy_y_test <- train_test$test$true_value
sapply(soy_X_test, function(x) get_MAPE(soy_y_test, x))

plot(c(train_test$train$true_value, train_test$test$true_value), type='l', main='Soy')
sapply(soy_X_test, function(x) lines(c(rep(NA, 2017-1980), x), col=x))
```

