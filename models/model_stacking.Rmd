---
title: "Model Stacking"
author: "Beau Smit"
date: "2/28/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(ggplot2)
```

```{r}
# original data
ag_df <- read.csv('MN_Ag_YieldsAndInputs.csv') %>% 
  mutate(set = ifelse(Year < 2017, "train", "validation"),
         set= ifelse(Year > 2020, "test", set))

corn_train <- ag_df %>% 
  filter(set == "train") %>%
  select(Year, Corn_BUperAcre)

corn_validation <- ag_df %>% 
  filter(set == "validation") %>%
  select(Year, Corn_BUperAcre)

corn_test <- ag_df %>% 
  filter(set == "test") %>%
  select(Year, Corn_BUperAcre)

corn_preds <- read.csv("corn_predictions.csv")
```

### Simply take the average of the model predictions

```{r}
mean_preds <- corn_preds %>% 
  mutate(mean_pred = rowMeans(corn_preds %>% select(-Year)))
```

```{r}
plot_df <- ag_df %>%
  dplyr::select(c("Year", "Corn_BUperAcre")) %>%
  left_join(., mean_preds, by="Year") %>%
  dplyr::select(c("Year", "Corn_BUperAcre", "mean_pred"))

ggplot(data = plot_df) + 
  geom_line(aes(x=Year, y=Corn_BUperAcre)) + 
  geom_line(aes(x=Year, y=mean_pred, color="prediction"))
```

### build a linear regression to stack models

```{r}
validation_set <- corn_validation %>%
  left_join(corn_preds, by="Year")


stacking_model <- glm(Corn_BUperAcre ~ 0 + drift_predictions + holt_predictions + arima_predictions, data=validation_set)

summary(stacking_model)

predicted <- predict(stacking_model, newdata = corn_preds %>% filter(Year == 2021))
observed <- corn_test$Corn_BUperAcre

predicted - observed
```

This is simplified code. Really, we should use sliding/expanding window cross validation to learn the stacking coefficients.

```{r}
# TODO: add linear regression into graph
ggplot(data = plot_df) + 
  geom_line(aes(x=Year, y=Corn_BUperAcre)) + 
  geom_line(aes(x=Year, y=mean_pred, color="prediction"))
```

```{r}
# TODO: other stacking methods - rf?
```

