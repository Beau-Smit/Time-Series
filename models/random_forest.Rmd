---
title: "andresc_dataexploration"
author: "Andres Crucetta"
date: "2/25/2022"
output: html_document
---
```{r}
install.packages('randomForest', repos = "http://cran.us.r-project.org")
install.packages('caret', repos = "http://cran.us.r-project.org")
```

```{r}
library(httr)
library(usdarnass)
library(tidyverse)
library(forecast)
library(knitr)
library("tidyverse")
library("forecast")
library("TSA")
library("tseries")
library("MuMIn")
library("randomForest")
library(gbm)
library(caret)
```


```{r reading_csv}
ag_df = read.csv('MN_Ag_YieldsAndInputs.csv')

# only keep years where all 3 commodities have values
ag_df = ag_df[!is.na(ag_df$Soy_BUperAcre),] %>% arrange(Year)

# make into time series
corn_ts <- ts(ag_df$Corn_BUperAcre, start = min(ag_df$Year), frequency = 1)
wheat_ts <- ts(ag_df$Wheat_BUperAcre, start = min(ag_df$Year), frequency = 1)
soy_ts <- ts(ag_df$Soy_BUperAcre, start = min(ag_df$Year), frequency = 1)

# split train and test sets
first_test_yr <- 2017

corn_train <- window(corn_ts, end=first_test_yr-1)
corn_test <- window(corn_ts, start=first_test_yr)

wheat_train <- window(wheat_ts, end=first_test_yr-1)
wheat_test <- window(wheat_ts, start=first_test_yr)

soy_train <- window(soy_ts, end=first_test_yr-1)
soy_test <- window(soy_ts, start=first_test_yr)
```

```{r}
autoplot(corn_ts,main="Corn Production 1934-2016")
autoplot(diff(corn_ts),main="Differenced Corn Production 1934-2016")
```


```{r}
lag_order <- 6 # the desired number of lags (6 years)
horizon <- 5 # the forecast horizon (5 years)

corn_embed <- embed(corn_ts, lag_order+1)

y_train <- corn_embed[, 1] # the target
X_train <- corn_embed[, -1] # everything but the target

y_test <- window(corn_ts, start = c(2016), end = c(2021))
X_test <- tail(corn_embed[,-1])
```

```{r ts_crossval}
#### creating sampling seeds ####
set.seed(123)
seeds <- vector(mode = "list", length = 528)
for(i in 1:527) seeds[[i]] <- sample.int(1000, 5)

## For the last model:
seeds[[528]] <- sample.int(1000, 1)

#########
myTimeControl <- trainControl(method = "timeslice",
                              initialWindow = 60,
                              horizon = 5,
                              fixedWindow = FALSE,
                              allowParallel = TRUE,
                              seeds = seeds)

colnames(X_train) <- c('Lag1','Lag2','Lag3','Lag4','Lag5','Lag6')
colnames(X_test) <- c('Lag1','Lag2','Lag3','Lag4','Lag5','Lag6')

tuneLength.num <- 5

rf.mod <- train(x=X_train,
                y=y_train,
                method = "rf",
                ntree=5,
                trControl = myTimeControl,
                tuneLength=tuneLength.num,
                metric='RMSE')

gbm.mod <- train(x=X_train,
                y=y_train,
                method = "gbm",
                trControl = myTimeControl,
                tuneLength=tuneLength.num,
                metric='RMSE')
```

```{r}
resamps <- resamples(list(gbm=xg.mod,
                          rf=rf.mod))

ss <- summary(resamps)

knitr::kable(ss[[3]]$RMSE)

trellis.par.set(caretTheme())
dotplot(resamps, metric = "RMSE")

```

```{r testing}
forecasts_rf <- predict(rf.mod, X_test)
forecasts_gbm <- predict(gbm.mod, X_test)

```

```{r}

# convert to ts format
y_pred_rf <- ts(
  forecasts_rf,
  start = c(2016),
  frequency = 1
)

y_pred_gbm <- ts(
  forecasts_gbm,
  start = c(2016),
  frequency = 1
)


benchmark <- forecast(naive(corn_train), h = horizon)

autoplot(corn_train) +
  autolayer(y_pred,series="Random Forest Prediction")+
  autolayer(y_test,series="Actual Values") +
  autolayer(benchmark$mean,series="Naive Forecast")+
  autolayer(y_pred_xgb,series="Gradient Boost")

accuracy(y_pred, y_test)
```


```{r}

accuracy(y_pred,y_test)
accuracy(benchmark, y_test)

```

