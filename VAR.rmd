---
title: "Ag Yield Prediction - VAR"
output: html_document
---

```{r setup, include=FALSE}
# library(fpp)
# library(TSA)
# library(tseries)
library(tidyverse)
library(forecast)
# library(lubridate)
# library(scales)
# library(readxl)
library(knitr)
library(vars)
# library(corrplot)
# library(GGally)
knitr::opts_chunk$set(echo = TRUE)
```

Step 0) read in Corn, Soy, and Wheat data for Minnesota:

```{r}
ag_df = read.csv('MN_Ag_YieldsAndInputs.csv')
```

For the purposes of the VAR, we will drop the rows that don't have a value for all three crops. Ultimately, this is observations rows (1934 - 2021).

```{r}
ag_df = ag_df[!is.na(ag_df$Soy_BUperAcre),]
head(ag_df)
```
As we can see here, we don't have fertilizer input information for each year of data. We can use a spline approach to interpolate the missing values, but this will be trickier for the newer values as we don't have data on either side and we're essentially forecasting things that already happened.

```{r}
ag_plot = ag_df %>% pivot_longer(cols = ends_with('BUperAcre'))
ggplot(ag_plot, aes(x = Year, y = value, col = name)) + 
    geom_line() +
    ggtitle('Yield - BU Per Acre') +
    scale_color_discrete(name = 'Crop', labels = c('Corn', 'Soybeans', 'Wheat')) + 
    ylab('BU / Acre')
```

Our data look a bit heteroskedastic - especially in the down years. Let's use a box cox transformation and see if we can make an improvement.

```{r}
ag_yields = ag_df[,1:4]
BoxCox.lambda(ts(ag_yields[,2:4]))
```
This is pretty close to a straight log transformation.

```{r}
ag_plot = ag_df[,2:4] %>%
    BoxCox(0.04355743) %>%
    cbind(Year = ag_df[,1]) %>%
    pivot_longer(cols = ends_with('BUperAcre'))

ggplot(ag_plot, aes(x = Year, y = value, col = name)) + 
    geom_line() +
    ggtitle('Yield - BU Per Acre (Box Cox Transformed with lambda = .044)') +
    scale_color_discrete(name = 'Crop', labels = c('Corn', 'Soybeans', 'Wheat')) + 
    ylab('BU / Acre')
```

This makes the perturbations look a bit less extreme - we will go with this moving forward. 

```{r}
ag_lambda = 0.04355743

ag_transformed = ag_df[,2:4] %>%
    BoxCox(0.04355743) %>%
    cbind(Year = ag_df[,1])

lead_years = 5
mae_df = data.frame()
aicc_df = data.frame()

for (p_lag in 5:1) {

    for (idx in 40:(nrow(ag_transformed) - 1)){
      #increase iteration number
      it_number = idx - 39
    
      test_ts = ag_transformed[(idx + 1):(idx + lead_years), 1:3]
      
      train_expand = ag_transformed[1:idx, 1:3] %>% ts()
      train_slide = ag_transformed[(idx - 39):idx, 1:3] %>% ts()
      
      # VAR Expanding
      m1 = VAR(train_slide, p = p_lag, type = 'both')
      f1 = forecast(m1, h=lead_years)

      mae_corn = abs(f1$forecast$Corn_BUperAcre$mean - test_ts$Corn_BUperAcre)
      mae_wheat = abs(f1$forecast$Wheat_BUperAcre$mean - test_ts$Wheat_BUperAcre)
      mae_soy = abs(f1$forecast$Soy_BUperAcre$mean - test_ts$Soy_BUperAcre)
    
      newlines = data.frame(mae_corn, mae_wheat, mae_soy) %>%
          t() %>% 
          cbind(data.frame(model = 'Expanding VAR',
                           crop = c('Corn', 'Wheat', 'Soy')))

      mae_df = bind_rows(mae_df, newlines)

      # VAR Sliding
      m2 = VAR(train_expand, p = p_lag, type = 'both')
      f2 = forecast(m2, h=lead_years)
      
      mae_corn = abs(f2$forecast$Corn_BUperAcre$mean - test_ts$Corn_BUperAcre)
      mae_wheat = abs(f2$forecast$Wheat_BUperAcre$mean - test_ts$Wheat_BUperAcre)
      mae_soy = abs(f2$forecast$Soy_BUperAcre$mean - test_ts$Soy_BUperAcre)
    
      newlines = data.frame(mae_corn, mae_wheat, mae_soy) %>%
          t() %>% 
          cbind(data.frame(model = 'Sliding VAR',
                           crop = c('Corn', 'Wheat', 'Soy')))
      
      mae_df = bind_rows(mae_df, newlines)

      # aicc_df = bind_rows(aicc_df, data.frame(
      #       'iteration' = it_number,
      #       'lag' = p_lag,
      #       'Expanding ARIMA' = m1$aicc,
      #       'Sliding ARIMA' = m2$aicc
      # ))
    }    
}

```

